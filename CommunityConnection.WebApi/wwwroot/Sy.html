<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Developer Chat</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 30px;
            background-color: #f2f2f2;
        }

        h2 {
            color: #333;
        }

        .chat-container {
            max-width: 600px;
            margin: auto;
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }

        #messages {
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            margin: 10px 0;
            background-color: #fafafa;
        }

        #messageInput {
            padding: 10px;
            width: 100%;
            box-sizing: border-box;
        }

        .msg {
            margin: 5px 0;
        }

            .msg strong {
                color: #007bff;
            }

            .msg time {
                font-size: 0.8em;
                color: #999;
            }

        .room-info {
            font-style: italic;
            color: #666;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <h2>Phòng Chat</h2>
        <div class="room-info">Bạn đang chat với tên: <strong>Dương Thế Sỹ</strong> - Phòng: <strong>Developer</strong></div>
        <div id="messages"></div>
        <input id="messageInput" type="text" placeholder="Gõ tin nhắn và nhấn Enter..." />
    </div>

    <script>
        // Gán cứng tên người dùng và phòng
        const userName = "Dương Thế Sỹ";
        const roomName = "Developer";

        // Kết nối SignalR
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .withAutomaticReconnect()
            .build();

        // Khi kết nối thành công, tự động vào phòng
        connection.start()
            .then(() => {
                setTimeout(() => {
                    connection.invoke("JoinRoom", userName, roomName);
                }, 3000)
            })
            .catch(console.error);

        // Gửi tin nhắn khi nhấn Enter
        document.getElementById("messageInput").addEventListener("keyup", function (e) {
            if (e.key === "Enter") {
                const msg = e.target.value.trim();
                if (msg !== "") {
                    connection.invoke("SendMessageToRoom", roomName, msg);
                    e.target.value = "";
                }
            }
        });

        // Nhận tin nhắn từ server
        connection.on("ReceiveMessage", function (msg) {
            appendMessage(msg.user, msg.text, new Date());
        });

        // Thông báo khi người dùng vào hoặc rời phòng
        //connection.on("UserJoined", function (user) {
        //    appendSystemMessage(`${user} đã tham gia phòng.`);
        //});

        connection.on("UserLeft", function (user) {
            appendSystemMessage(`${user} đã rời phòng.`);
        });

        function appendMessage(user, text, time) {
            const messages = document.getElementById("messages");
            const p = document.createElement("p");
            p.className = "msg";
            p.innerHTML = `<strong>${user}</strong>: ${text} <time>${time.toLocaleTimeString()}</time>`;
            messages.appendChild(p);
            messages.scrollTop = messages.scrollHeight;
        }

        function appendSystemMessage(content) {
            const messages = document.getElementById("messages");
            const p = document.createElement("p");
            p.innerHTML = `<i>${content}</i>`;
            messages.appendChild(p);
            messages.scrollTop = messages.scrollHeight;
        }
        // Sau khi kết nối SignalR và JoinRoom thành công, gọi API để lấy tin nhắn cũ
        fetch('http://localhost:5097/api/communities/1/channels/1/messages', {
            method: 'GET',
            headers: {
                'Authorization': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1bmlxdWVfbmFtZSI6ImR1b25ndGhlc3kiLCJyb2xlIjoiVXNlciIsIm5hbWVpZCI6IjEiLCJuYmYiOjE3NTM2NTAxNjIsImV4cCI6MTc1MzY1MTk2MiwiaWF0IjoxNzUzNjUwMTYyfQ.1p_E59MX2exAXPE2YaeKGhGmcgpKnF-5JuLCGeBpdzI',
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(result => {
                if (result.status === "true" && Array.isArray(result.data.messages)) {
                    const fragment = document.createDocumentFragment();

                    result.data.messages.forEach(msg => {
                        const user = msg.senderName;
                        const text = msg.message.content;
                        const time = new Date(msg.message.sentAt);

                        const p = document.createElement("p");
                        p.className = "msg";
                        p.innerHTML = `<strong>${user}</strong>: ${text} <time>${time.toLocaleTimeString()}</time>`;
                        fragment.appendChild(p);
                    });

                    const messages = document.getElementById("messages");
                    messages.appendChild(fragment);
                    messages.scrollTop = messages.scrollHeight;
                } else {
                    console.warn("Không lấy được danh sách tin nhắn.");
                }
            })
            .catch(err => console.error("Lỗi gọi API:", err));

    </script>
</body>
</html>
